name: Documentation

on:
  push:
    branches: [ main, master ]
    paths:
      - 'docs/**'
      - 'cmd/**'
      - 'pkg/**'
      - 'internal/**'
      - 'scripts/generate-docs.sh'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'docs/**'
      - 'cmd/**'
      - 'pkg/**'
      - 'internal/**'
      - 'scripts/generate-docs.sh'
  workflow_dispatch:

jobs:
  validate-docs:
    name: Validate Documentation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.24.4'
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq
        
    - name: Make script executable
      run: chmod +x scripts/generate-docs.sh
      
    - name: Validate documentation
      run: |
        scripts/generate-docs.sh --validate
        scripts/generate-docs.sh --toc
        scripts/generate-docs.sh --coverage
        
    - name: Check for broken links
      uses: gaurav-nelson/github-action-markdown-link-check@v1
      with:
        use-quiet-mode: 'yes'
        use-verbose-mode: 'yes'
        config-file: '.github/markdown-link-check.json'

  build-docs:
    name: Build Documentation
    runs-on: ubuntu-latest
    needs: validate-docs
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.24.4'
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq
        
    - name: Make script executable
      run: chmod +x scripts/generate-docs.sh
      
    - name: Generate documentation
      run: |
        scripts/generate-docs.sh --all
        
    - name: Create build directory
      run: |
        mkdir -p build/docs
        cp -r docs/* build/docs/
        
    - name: Upload documentation artifacts
      uses: actions/upload-artifact@v3
      with:
        name: documentation
        path: build/docs/
        retention-days: 30

  deploy-docs:
    name: Deploy Documentation
    runs-on: ubuntu-latest
    needs: build-docs
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download documentation artifacts
      uses: actions/download-artifact@v3
      with:
        name: documentation
        path: build/docs/
        
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./build/docs
        cname: docs.virakcloud.com

  check-docs-coverage:
    name: Check Documentation Coverage
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.24.4'
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq
        
    - name: Make script executable
      run: chmod +x scripts/generate-docs.sh
      
    - name: Check documentation coverage
      run: |
        scripts/generate-docs.sh --coverage
        
    - name: Comment PR with coverage report
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          
          // Read coverage report from script output
          // This is a simplified example - you might need to enhance this
          const coverageReport = fs.readFileSync('coverage-report.txt', 'utf8');
          
          // Create comment
          const comment = `## Documentation Coverage Report
          
          ${coverageReport}
          
          ---
          
          *This report was generated automatically by the documentation workflow.*`;
          
          // Post comment to PR
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  notify-docs-update:
    name: Notify Documentation Update
    runs-on: ubuntu-latest
    needs: deploy-docs
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: Notify on Slack
      if: env.SLACK_WEBHOOK_URL != ''
      uses: 8398a7/action-slack@v3
      with:
        status: success
        text: "Virak CLI documentation has been updated and deployed to https://docs.virakcloud.com"
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Documentation ${{ github.ref }}
        body: |
          Documentation update for release ${{ github.ref }}.
          
          View the updated documentation at: https://docs.virakcloud.com
        draft: false
        prerelease: false